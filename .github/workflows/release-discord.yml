name: Notify Discord on Release and Push Changelog

on:
  release:
    types: [published]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send custom embed to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          EMBED=$(jq -n \
            --arg title "üì¶ ${{ github.event.release.tag_name }}" \
            --arg desc "${{ github.event.release.body }}" \
            --arg url "${{ github.event.release.html_url }}" \
            --arg timestamp "${{ github.event.release.published_at }}" \
            '{
              "embeds": [
                {
                  "title": $title,
                  "description": $desc,
                  "url": $url,
                  "color": 7679428,
                  "timestamp": $timestamp,
                  "footer": {
                    "text": "Venoxity Network",
                    "icon_url": "https://cdn.discordapp.com/attachments/1368433399978790914/1386875786899750913/VText.png?ex=685b4c3a&is=6859faba&hm=4141466c5761e82f3369a595c10d5268169b0b1c9a6dafd95f9d7401c2f62d60"
                  }
                }
              ]
            }')

          curl -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "$EMBED"

  push-docs:
    needs: notify
    runs-on: ubuntu-latest
    steps:
      - name: Commit release notes to plugin changelog
        run: |
          git config --global user.name "venoxity-ci"
          git config --global user.email "contact@venoxity.dev"

          git clone https://x-access-token:${{ secrets.CI_BOT_PAT }}@github.com/Venoxity-Development/documentation.git
          cd documentation

          FULL_TAG="${{ github.event.release.tag_name }}"
          PLUGIN_NAME=$(echo "$FULL_TAG" | cut -d'-' -f2)
          PLUGIN_DIR=$(echo "$PLUGIN_NAME" | tr '[:upper:]' '[:lower:]')
          RELEASE_VERSION=$(echo "$FULL_TAG" | cut -d'-' -f3)

          CHANGELOG_PATH="plugins/${PLUGIN_DIR}/changelogs.md"

          if [ ! -f "$CHANGELOG_PATH" ]; then
            echo "‚ùå Changelog not found at $CHANGELOG_PATH"
            exit 1
          fi

          NEW_ENTRY=$(cat <<EOF

---

## ${RELEASE_VERSION}

${{ github.event.release.body }}
EOF
)

          TEMP_FILE=$(mktemp)
          echo "$NEW_ENTRY" > "$TEMP_FILE"
          cat "$CHANGELOG_PATH" >> "$TEMP_FILE"
          mv "$TEMP_FILE" "$CHANGELOG_PATH"

          git add "$CHANGELOG_PATH"
          git commit -m "Update changelog for $PLUGIN_NAME $RELEASE_VERSION"
          git push origin main